# MyResty CRUD 代码生成器

基于 Ant Design Pro 前端项目中的 `scripts/*.json` 配置文件，自动生成后端 CRUD 代码。

## 1. 功能特性

- **统一接口风格** - 所有接口支持 GET/POST/PUT/DELETE
- **自动 JOIN 支持** - 解析关联表配置
- **分页兼容** - 与 Ant Design Pro 分页参数一致
- **参数自动合并** - 自动处理 GET/POST/JSON Body 参数

---

## 2. JSON 配置格式

配置文件路径：`/home/quqiufeng/my-ant-design-pro/scripts/admin.json`

### 完整配置示例

```json
{
  "path": "/admin/admin-list",
  "table": "admin",
  "search_field": [
    "username",
    "phone",
    {
      "field": "role_id",
      "type": "select",
      "api": "/api/role",
      "displayField": "name",
      "valueField": "id"
    }
  ],
  "list_field": [
    "id",
    "username",
    "phone",
    "role_id",
    "left join role on role_id=id display name as role_name"
  ],
  "create_field": ["username", "password", "phone", "role_id"],
  "update_field": ["username", "password", "phone", "role_id"]
}
```

### 字段说明

| 字段 | 必填 | 类型 | 说明 |
|------|------|------|------|
| `path` | 否 | string | 前端页面路径（仅供参考） |
| `table` | 是 | string | 数据库表名 |
| `search_field` | 否 | array | 搜索字段配置，支持字符串或对象格式 |
| `list_field` | 否 | array | 列表显示字段，支持 JOIN 语法 |
| `create_field` | 否 | array | 创建表单字段 |
| `update_field` | 否 | array | 更新表单字段 |

### 搜索字段配置

**简单字段**：
```json
"search_field": ["username", "phone"]
```

**级联选择字段**：
```json
{
  "field": "role_id",
  "type": "select",
  "api": "/api/role",
  "displayField": "name",
  "valueField": "id"
}
```

### JOIN 语法

```
left join {table} on {left_field}={right_field} display {field} as {alias}
```

示例：
```
left join role on role_id=id display name as role_name
```

生成 SQL：
```sql
SELECT admin.id, admin.username, role.name as role_name
FROM admin LEFT JOIN role ON admin.role_id = role.id
```

---

## 3. 使用方法

### 安装依赖

确保 LuaJIT 已安装：
```bash
sudo ln -s /usr/local/web/luajit/bin/luajit /usr/local/bin/luajit
luajit -v
```

### 生成命令

```bash
cd /var/www/web/my-openresty

# 方式一：标准语法（推荐）
luajit myresty curd /home/quqiufeng/my-ant-design-pro/scripts/admin.json

# 方式二：输入重定向语法
luajit myresty curd < /home/quqiufeng/my-ant-design-pro/scripts/admin.json

# 生成其他表 CRUD
luajit myresty curd /home/quqiufeng/my-ant-design-pro/scripts/role.json
```

### 生成的文件

| 文件 | 说明 |
|------|------|
| `app/models/{Name}Model.lua` | 数据模型（list/detail/create/update/delete/count 方法） |
| `app/controllers/{Name}.lua` | 统一接口控制器（支持 GET/POST/PUT/DELETE） |

### 路由配置

自动生成的路由配置（已包含在 `app/routes.lua`）：

```lua
-- Admin CRUD
route:any('/admin/list', 'admin:list')
route:any('/admin/detail', 'admin:detail')
route:any('/admin/create', 'admin:create')
route:any('/admin/update', 'admin:update')
route:any('/admin/delete', 'admin:delete')

-- Role CRUD
route:any('/role/list', 'role:list')
route:any('/role/detail', 'role:detail')
route:any('/role/create', 'role:create')
route:any('/role/update', 'role:update')
route:any('/role/delete', 'role:delete')
```

**说明**：
- 控制器名称首字母小写（如 `admin:list` 而非 `Admin:list`）
- 自动生成路由注释标记：`-- Admin API (Generated by curd command)`

---

## 4. 接口文档

### 通用说明

- **请求方式** - 支持 GET/POST/PUT/DELETE（统一使用 `route:any`）
- **参数格式** - 支持 JSON Body、表单、URL Query
- **响应格式** - 统一 JSON 响应

### 响应格式

```json
{
  "success": true,
  "message": "success",
  "data": {},
  "total": 10,
  "page": 1,
  "pageSize": 10
}
```

### 接口列表

#### 列表查询

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/list` | ANY | 管理员列表 |
| `/role/list` | ANY | 角色列表 |

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `page` | number | 否 | 当前页码，默认 1 |
| `pageSize` | number | 否 | 每页数量，默认 10 |
| `keyword` | string | 否 | 关键词搜索 |

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "username": "admin",
      "phone": "13800138000",
      "role_id": 1,
      "role_name": "超级管理员"
    }
  ],
  "total": 100,
  "page": 1,
  "pageSize": 10
}
```

#### 详情查询

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/detail` | ANY | 管理员详情 |
| `/role/detail` | ANY | 角色详情 |

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | number | 是 | 记录 ID |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "username": "admin",
    "phone": "13800138000",
    "role_id": 1,
    "role_name": "超级管理员",
    "created_at": "2026-02-05 10:00:00"
  }
}
```

#### 新建

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/create` | ANY | 新建管理员 |
| `/role/create` | ANY | 新建角色 |

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `username` | string | 是 | 用户名 |
| `password` | string | 否 | 密码（需加密） |
| `phone` | string | 否 | 手机号 |
| `role_id` | number | 否 | 角色 ID |

**响应示例**：
```json
{
  "success": true,
  "message": "Created",
  "data": {
    "id": 101
  }
}
```

#### 更新

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/update` | ANY | 更新管理员 |
| `/role/update` | ANY | 更新角色 |

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | number | 是 | 记录 ID |
| `username` | string | 否 | 用户名 |
| `phone` | string | 否 | 手机号 |
| `role_id` | number | 否 | 角色 ID |

**响应示例**：
```json
{
  "success": true,
  "message": "Updated"
}
```

#### 删除

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/delete` | ANY | 删除管理员 |
| `/role/delete` | ANY | 删除角色 |

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | number | 是 | 记录 ID |

**响应示例**：
```json
{
  "success": true,
  "message": "Deleted"
}
```

---

## 5. 请求示例

### 列表查询

```bash
# GET 请求
curl "http://localhost:8080/admin/list?page=1&pageSize=10&keyword=admin"

# POST 请求 (JSON)
curl -X POST "http://localhost:8080/admin/list" \
  -H "Content-Type: application/json" \
  -d '{"page":1,"pageSize":10,"keyword":"admin"}'

# POST 请求 (表单)
curl -X POST "http://localhost:8080/admin/list" \
  -d "page=1&pageSize=10&keyword=admin"
```

### 详情查询

```bash
# GET
curl "http://localhost:8080/admin/detail?id=1"

# POST
curl -X POST "http://localhost:8080/admin/detail" \
  -H "Content-Type: application/json" \
  -d '{"id":1}'
```

### 新建

```bash
# POST (JSON)
curl -X POST "http://localhost:8080/admin/create" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "phone": "13900139000",
    "role_id": 2
  }'
```

### 更新

```bash
# PUT
curl -X PUT "http://localhost:8080/admin/update" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "username": "updated",
    "phone": "13700137000"
  }'

# POST
curl -X POST "http://localhost:8080/admin/update" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "username": "updated"
  }'
```

### 删除

```bash
# DELETE
curl -X DELETE "http://localhost:8080/admin/delete?id=1"

# GET
curl "http://localhost:8080/admin/delete?id=1"

# POST
curl -X POST "http://localhost:8080/admin/delete" \
  -H "Content-Type: application/json" \
  -d '{"id":1}'
```

---

## Ant Design Pro 对接

### ProTable 请求配置

```typescript
// API 配置
const adminApi = {
  listApi: '/admin/list',
  detailApi: '/admin/detail',
  addApi: '/admin/create',
  updateApi: '/admin/update',
  deleteApi: '/admin/delete',
};

// 请求示例
const response = await request('/admin/list', {
  method: 'POST',
  body: {
    page: 1,
    pageSize: 10,
    keyword: searchValue,
  },
});

// 处理响应
if (response.success) {
  setDataSource(response.data);
  setPagination({
    total: response.total,
    pageSize: response.pageSize,
    current: response.page,
  });
}
```

### ProDescriptions 请求配置

```typescript
const adminDescriptions = {
  api: '/admin/detail',
  params: {
    id: '123',
  },
};
```

---

## 错误处理

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 400 | 缺少必要参数 |
| 404 | 记录不存在 |
| 500 | 服务器错误 |

### 错误响应

```json
{
  "success": false,
  "message": "id required",
  "data": null
}
```
