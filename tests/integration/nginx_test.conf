# MyResty Integration Test Nginx Configuration
# 这个配置文件包含所有测试需要的路由

# 测试路由器
location /api/users {
    content_by_lua_block {
        local Router = require('app.core.Router')
        local Response = require('app.core.Response')
        local router = Router:new()
        
        -- 定义路由
        router:get('/api/users', function()
            Response:json({users = {{id=1,name="John"},{id=2,name="Jane"}}})
        end)
        
        router:get('/api/users/:id', function(params)
            Response:json({id = tonumber(params.id), name = "User " .. params.id})
        end)
        
        router:post('/api/users', function()
            Response:json({message = "User created"}, 201)
        end)
        
        router:put('/api/users/:id', function(params)
            Response:json({id = tonumber(params.id), message = "User updated"})
        end)
        
        router:delete('/api/users/:id', function(params)
            Response:json({id = tonumber(params.id), message = "User deleted"})
        end)
        
        local method = ngx.req.get_method()
        local uri = ngx.var.uri
        
        local h, params = router:match(uri, method)
        if h then
            h(params)
        else
            Response:json({error = "Not found"}, 404)
        end
    }
}

location /api/posts/:post_id/comments/:comment_id {
    content_by_lua_block {
        local Response = require('app.core.Response')
        local post_id = ngx.var.post_id
        local comment_id = ngx.var.comment_id
        Response:json({
            post_id = post_id,
            comment_id = comment_id,
            message = "Nested route works"
        })
    }
}

location /api/search {
    content_by_lua_block {
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        Response:json({
            q = args.q,
            page = tonumber(args.page) or 1,
            results = {"result1", "result2"}
        })
    }
}

# 测试会话
location /auth/login {
    content_by_lua_block {
        local Session = require('app.lib.session')
        local Response = require('app.core.Response')
        local args = ngx.req.get_post_args()
        
        local session = Session:new()
        session:set('user_id', 1)
        session:set('username', args.username or 'testuser')
        session:set('logged_in', true)
        session:save()
        
        -- 设置cookie
        ngx.header['Set-Cookie'] = session:to_cookie()
        
        Response:json({message = "Logged in", session_id = session:get_id()})
    }
}

location /auth/logout {
    content_by_lua_block {
        local Session = require('app.lib.session')
        local Response = require('app.core.Response')
        
        local session = Session:new()
        session:destroy()
        
        -- 清除cookie
        ngx.header['Set-Cookie'] = 'session=; expires=Thu, 01 Jan 1970 00:00:00 GMT'
        
        Response:json({message = "Logged out"})
    }
}

location /auth/profile {
    content_by_lua_block {
        local Session = require('app.lib.session')
        local Response = require('app.core.Response')
        
        local session = Session:new()
        session:start()
        
        if not session:get('logged_in') then
            Response:json({error = "Not authenticated"}, 401)
            return
        end
        
        Response:json({
            user_id = session:get('user_id'),
            username = session:get('username'),
            session_id = session:get_id()
        })
    }
}

location /auth/session-info {
    content_by_lua_block {
        local Session = require('app.lib.session')
        local Response = require('app.core.Response')
        
        local session = Session:new()
        session:start()
        
        Response:json({
            is_new = session:is_new_session(),
            data_count = #session:get_all_data()
        })
    }
}

location /cart {
    content_by_lua_block {
        local Session = require('app.lib.session')
        local Response = require('app.core.Response')
        
        local session = Session:new()
        session:start()
        
        local cart = session:get('cart') or {}
        Response:json({cart = cart})
    }
}

location /cart/items {
    content_by_lua_block {
        local Session = require('app.lib.session')
        local Response = require('app.core.Response')
        local args = ngx.req.get_post_args()
        
        local session = Session:new()
        session:start()
        
        local cart = session:get('cart') or {}
        table.insert(cart, {
            product_id = tonumber(args.product_id),
            quantity = tonumber(args.quantity),
            added_at = os.time()
        })
        session:set('cart', cart)
        
        Response:json({cart = cart, message = "Item added"})
    }
}

# 测试帮助器
location /helper/format-date {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local ts = tonumber(args.ts) or os.time()
        local format = args.format or '%Y-%m-%d %H:%M:%S'
        
        local formatted = Helper.format_date(ts, format)
        Response:json({timestamp = ts, formatted = formatted})
    }
}

location /helper/uuid {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        
        local uuid = Helper.uuid()
        Response:json({uuid = uuid})
    }
}

location /helper/random-string {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local length = tonumber(args.length) or 16
        local str = Helper.random_string(length)
        Response:json({length = length, random = str})
    }
}

location /helper/validate-email {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local valid = Helper.is_valid_email(args.email)
        Response:json({email = args.email, valid = valid})
    }
}

location /helper/validate-url {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local valid = Helper.is_valid_url(args.url)
        Response:json({url = args.url, valid = valid})
    }
}

location /helper/validate-phone {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local valid = Helper.is_valid_phone(args.phone)
        Response:json({phone = args.phone, valid = valid})
    }
}

location /helper/sanitize {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local sanitized = Helper.sanitize(args.text)
        Response:json({original = args.text, sanitized = sanitized})
    }
}

location /helper/escape-html {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local escaped = Helper.escape_html(args.text)
        Response:json({original = args.text, escaped = escaped})
    }
}

location /helper/pretty-json {
    content_by_lua_block {
        local Response = require('app.core.Response')
        local args = ngx.req.get_post_args()
        local cjson = require('cjson')
        
        local data = args.data
        local pretty = cjson.encode(cjson.decode(data))
        Response:json({formatted = pretty})
    }
}

location /helper/base64-encode {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local encoded = Helper.base64_encode(args.text)
        Response:json({original = args.text, encoded = encoded})
    }
}

location /helper/base64-decode {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local decoded = Helper.base64_decode(args.text)
        Response:json({encoded = args.text, decoded = decoded})
    }
}

location /helper/md5 {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local hash = Helper.md5(args.text)
        Response:json({text = args.text, md5 = hash})
    }
}

location /helper/paginate {
    content_by_lua_block {
        local Helper = require('app.utils.helper')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local page = tonumber(args.page) or 1
        local per_page = tonumber(args.per_page) or 10
        
        local data = {}
        for i = 1, 100 do data[i] = i end
        
        local paginated = Helper.paginate(data, page, per_page)
        Response:json({
            page = page,
            per_page = per_page,
            total = #data,
            items = paginated
        })
    }
}

# 测试缓存
location /cache/users {
    content_by_lua_block {
        local Cache = require('app.lib.cache')
        local Response = require('app.core.Response')
        
        local cache = Cache:new('users_cache')
        local users = cache:get('all_users')
        
        if not users then
            users = {{id=1,name="John"},{id=2,name="Jane"},{id=3,name="Bob"}}
            cache:set('all_users', users, 300) -- 5分钟缓存
            Response:json({users = users, from = "database"})
        else
            Response:json({users = users, from = "cache"})
        end
    }
}

location /cache/data {
    content_by_lua_block {
        local Cache = require('app.lib.cache')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local cache = Cache:new('test_cache')
        local key = args.key or 'default'
        local data = cache:get(key)
        
        if data then
            Response:json({key = key, data = data, from = "cache"})
        else
            data = {value = "test data for " .. key, timestamp = os.time()}
            cache:set(key, data, 60)
            Response:json({key = key, data = data, from = "database"})
        end
    }
}

location /cache/clear {
    content_by_lua_block {
        local Cache = require('app.lib.cache')
        local Response = require('app.core.Response')
        
        local cache = Cache:new('users_cache')
        cache:clear()
        
        Response:json({message = "Cache cleared"})
    }
}

# 测试查询构建器
location /db/users {
    content_by_lua_block {
        local QueryBuilder = require('app.db.query')
        local Response = require('app.core.Response')
        local args = ngx.req.get_uri_args()
        
        local qb = QueryBuilder:new('users')
        
        if args.id then qb:where('id', '=', tonumber(args.id)) end
        if args.name then qb:where('name', '=', args.name) end
        if args.status then qb:where('status', '=', args.status) end
        if args.role then qb:where('role', '=', args.role) end
        if args.search then qb:where('name', 'LIKE', '%' .. args.search .. '%') end
        
        if args.order_by then
            local order = args.order or 'ASC'
            qb:order_by(args.order_by, order)
        end
        
        if args.limit then qb:limit(tonumber(args.limit)) end
        if args.offset then qb:offset(tonumber(args.offset)) end
        
        if args.count then
            local count = qb:count()
            Response:json({count = count})
        else
            local sql = qb:to_sql()
            -- 模拟查询结果
            Response:json({
                query = sql,
                results = {{id=1,name="John"},{id=2,name="Jane"}},
                message = "Query executed successfully"
            })
        end
    }
}

# 测试响应
location /response/json {
    content_by_lua_block {
        local Response = require('app.core.Response')
        Response:json({message = "Hello", data = {key = "value"}})
    }
}

location /response/html {
    content_by_lua_block {
        local Response = require('app.core.Response')
        Response:html("<h1>Hello World</h1><p>This is HTML</p>")
    }
}

location /response/text {
    content_by_lua_block {
        local Response = require('app.core.Response')
        Response:text("This is plain text")
    }
}

location /response/xml {
    content_by_lua_block {
        local Response = require('app.core.Response')
        Response:xml("<root><message>Hello</message></root>")
    }
}

location /response/redirect {
    content_by_lua_block {
        local Response = require('app.core.Response')
        Response:redirect("/new-location", 302)
    }
}

location /new-location {
    content_by_lua_block {
        ngx.say("Redirected successfully!")
    }
}

location /response/status/:code {
    content_by_lua_block {
        local Response = require('app.core.Response')
        local code = tonumber(ngx.var.code) or 200
        Response:json({message = "Custom status"}, code)
    }
}

location /response/headers {
    content_by_lua_block {
        local Response = require('app.core.Response')
        ngx.header['X-Custom-Header'] = 'custom-value'
        ngx.header['X-Another-Header'] = 'another-value'
        Response:json({message = "Check headers"})
    }
}

location /response/empty {
    content_by_lua_block {
        local Response = require('app.core.Response')
        Response:set_status(204)
        Response:text("")
    }
}

# 测试中间件
location /middleware/test {
    content_by_lua_block {
        ngx.log(ngx.INFO, "Request logged: " .. ngx.var.uri)
        local Response = require('app.core.Response')
        Response:json({message = "Request processed", uri = ngx.var.uri})
    }
}

location /middleware/cors {
    content_by_lua_block {
        local origin = ngx.header['Origin'] or '*'
        ngx.header['Access-Control-Allow-Origin'] = origin
        ngx.header['Access-Control-Allow-Methods'] = 'GET, POST, PUT, DELETE, OPTIONS'
        ngx.header['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
        
        if ngx.req.get_method() == 'OPTIONS' then
            ngx.exit(204)
        end
        
        local Response = require('app.core.Response')
        Response:json({message = "CORS enabled"})
    }
}

location /middleware/rate-limit {
    content_by_lua_block {
        local Response = require('app.core.Response')
        local limit = 5
        local window = 60
        
        local key = ngx.var.binary_remote_addr
        local current = tonumber(ngx.var.cache_busy_level or 0) + 1
        
        -- 简单限流模拟
        Response:json({
            message = "Request allowed",
            remaining = limit - current,
            limit = limit
        })
    }
}

location /middleware/protected {
    content_by_lua_block {
        local Response = require('app.core.Response')
        local auth = ngx.header['Authorization']
        
        if not auth or auth ~= "Bearer test-token" then
            Response:json({error = "Unauthorized"}, 401)
            return
        end
        
        Response:json({
            message = "Access granted",
            user = "authenticated_user"
        })
    }
}

# 测试文件上传
location /upload {
    content_by_lua_block {
        local Response = require('app.core.Response')
        
        local function file_exists(path)
            local file = io.open(path, "r")
            if file then
                file:close()
                return true
            end
            return false
        end
        
        local file, err = ngx.req.get_body_file()
        
        if file and file_exists(file) then
            local filename = ngx.var.http_content_disposition or "uploaded_file"
            Response:json({
                message = "File uploaded successfully",
                filename = filename,
                size = 1000,
                path = file
            })
        else
            Response:json({
                message = "No file uploaded",
                error = err or "No file"
            }, 400)
        end
    }
}
