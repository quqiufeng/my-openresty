#!/usr/bin/env luajit
-- MyResty CLI Tool

package.path = '/var/www/web/my-openresty/?.lua;/var/www/web/my-openresty/?/init.lua;/usr/local/web/?.lua;;'
package.cpath = '/var/www/web/my-openresty/?.so;/usr/local/web/lualib/?.so;;'

local commands = {
    make = 'app.console.commands.Make',
    curd = 'app.console.commands.Curd',
}

local function print_help()
    print([[
MyResty CLI v1.0.0

Usage: myresty <command> [options]

Commands:
  make:<type> <name>   Generate code files
  curd <table_name>    Generate CRUD for a table
]])
end

-- 解析命令行参数
local raw_args = {...}
local cmd = raw_args[1]

if not cmd or cmd == '--help' or cmd == '-h' then
    print_help()
    os.exit(0)
end

if cmd == '--version' or cmd == '-v' then
    print('MyResty CLI v1.0.0')
    os.exit(0)
end

-- 处理 make:<type> 格式
local main_cmd = cmd
local sub_args = {}

if cmd:find(':') then
    main_cmd = cmd:gsub(':.*$', '')
    local sub_cmd = cmd:gsub('^.*:', '')
    sub_args = { sub_cmd }
    for i = 2, #raw_args do
        table.insert(sub_args, raw_args[i])
    end
else
    main_cmd = cmd
    for i = 2, #raw_args do
        table.insert(sub_args, raw_args[i])
    end
end

-- 查找命令
local command_path = commands[main_cmd]
if not command_path then
    print('[ERROR] Unknown command: ' .. main_cmd)
    os.exit(1)
end

-- 加载并执行命令
local ok, Command = pcall(require, command_path)
if not ok then
    print('[ERROR] Failed to load command')
    os.exit(1)
end

local cmd_instance = Command:new()
cmd_instance:run(sub_args)
